<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>

<style>
    .CodeMirror {
        height: 20rem;
        border-radius: 0.75rem;
        font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.875rem;
        background-color: #1a202c !important;
        /* gray-850 */
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.5rem;
    }

    .cm-s-dracula.CodeMirror {
        background-color: #1a202c !important;
    }

    .CodeMirror-focused {
        border-color: #FFCC00 !important;
        /* primary-500 */
        box-shadow: 0 0 0 1px #FFCC00;
    }
</style>

<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex items-center justify-between animate-fade-in-down">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl shadow-lg shadow-indigo-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Query Console</h1>
                <p class="text-gray-400 text-sm">Execute SQL queries directly</p>
            </div>
        </div>
        <a href="/connections/{{.ConnectionID}}"
            class="group flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white transition-colors">
            <div
                class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-primary-500 group-hover:text-white transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 transition-transform group-hover:-translate-x-0.5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </div>
            Back to Dashboard
        </a>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8 animate-fade-in-up">

        <!-- History Sidebar -->
        <div class="lg:col-span-1 order-2 lg:order-1">
            <div class="glass p-4 rounded-xl border border-white/5 h-full max-h-[600px] flex flex-col">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                            clip-rule="evenodd" />
                    </svg>
                    History
                </h3>

                <div id="history-list" class="overflow-y-auto custom-scrollbar flex-1 pr-2 space-y-3">
                    <div class="text-center py-8 text-gray-500 text-sm animate-pulse">Loading history...</div>
                </div>
            </div>
        </div>

        <!-- Query Editor Column -->
        <div class="lg:col-span-3 order-1 lg:order-2">
            <div class="glass p-6 rounded-2xl border border-white/5 shadow-2xl h-full">
                <div class="mb-4 flex justify-between items-center">
                    <label class="text-primary-300 text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-primary-500 animate-pulse"></span>
                        Input Query
                    </label>
                    <button id="run-query-btn"
                        class="group flex items-center gap-2 bg-primary-600 hover:bg-primary-500 text-white px-5 py-2 rounded-lg font-bold transition-all hover:scale-105 shadow-lg shadow-primary-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Execute Query
                    </button>
                </div>

                <div
                    class="relative shadow-inner rounded-xl overflow-hidden ring-1 ring-white/10 group-hover:ring-primary-500/30 transition-all">
                    <textarea id="query-input"
                        placeholder="SELECT * FROM system.tables LIMIT 10">SELECT * FROM system.tables LIMIT 50</textarea>
                </div>

                <div id="query-error"
                    class="bg-red-900/20 border border-red-500/50 rounded-lg p-4 mt-4 hidden animate-pulse">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-red-200 text-sm font-mono break-all" id="query-error-text"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Area -->
    <div id="loading-indicator" class="hidden text-center py-20">
        <div class="relative inline-block">
            <div class="absolute inset-0 bg-primary-500 blur-xl opacity-20 animate-pulse"></div>
            <div
                class="relative inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-700 border-t-primary-500 mb-4">
            </div>
        </div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">Processing query...</p>
    </div>

    <div id="results-area" class="hidden animate-fade-in-up">
        <div class="flex items-center gap-3 mb-6">
            <h2 class="text-xl font-bold text-white">Results</h2>
            <div class="h-px bg-gray-800 flex-1"></div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass p-3 rounded-xl border border-white/5 text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Duration</div>
                <div class="text-lg font-bold text-white" id="stat-duration">-</div>
            </div>
            <div class="glass p-3 rounded-xl border border-white/5 text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Rows Read</div>
                <div class="text-lg font-bold text-emerald-400" id="stat-rows">-</div>
            </div>
            <div class="glass p-3 rounded-xl border border-white/5 text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Bytes Read</div>
                <div class="text-lg font-bold text-blue-400" id="stat-bytes">-</div>
            </div>
            <div class="glass p-3 rounded-xl border border-white/5 text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Memory Peak</div>
                <div class="text-lg font-bold text-purple-400" id="stat-memory">-</div>
            </div>
            <div class="glass p-3 rounded-xl border border-white/5 text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Parts Read</div>
                <div class="text-lg font-bold text-gray-300" id="stat-parts">-</div>
            </div>
            <div class="glass p-3 rounded-xl border border-white/5 text-center">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Marks Read</div>
                <div class="text-lg font-bold text-gray-300" id="stat-marks">-</div>
            </div>
        </div>

        <!-- Table -->
        <div class="glass rounded-xl border border-white/5 overflow-hidden shadow-2xl">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-black/40 font-semibold border-b border-white/5">
                        <tr id="table-header">
                            <!-- Headers injected via JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-white/5">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
            <div id="no-results" class="hidden p-12 text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-800 mb-4">
                    <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <p class="text-gray-500 font-medium">Query executed successfully but returned no rows.</p>
            </div>
            <div id="limit-warning"
                class="hidden px-6 py-2 bg-yellow-900/20 text-yellow-500 text-xs text-center border-t border-yellow-500/10">
                Note: Display limited to top 100 rows for performance.
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }

    .animate-fade-in-down {
        animation: fadeInDown 0.5s ease-out forwards;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .custom-scrollbar::-webkit-scrollbar {
        height: 10px;
        background: #0f172a;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 5px;
        border: 2px solid #0f172a;
    }
</style>

<script>
    const connId = "{{.ConnectionID}}";

    // Initialize CodeMirror
    const editorConfig = {
        mode: 'text/x-sql',
        theme: 'dracula',
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        matchBrackets: true,
        autofocus: true, // Autofocus for console
        lineWrapping: true,
    };

    const editor = CodeMirror.fromTextArea(document.getElementById("query-input"), editorConfig);

    $(document).ready(function () {
        // Initial load
        loadHistory();

        $('#run-query-btn').click(function () {
            editor.save();
            const query = editor.getValue().trim();
            if (!query) return;

            // Reset UI
            $('#query-error').addClass('hidden');
            $('#results-area').addClass('hidden');
            $('#loading-indicator').removeClass('hidden');

            // Button Loading State
            const btn = $('#run-query-btn');
            const originalBtnHtml = btn.html();
            btn.prop('disabled', true).html(`
                <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Running...
            `);

            $.ajax({
                url: `/api/v1/connections/${connId}/query`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ query: query }),
                success: function (response) {
                    $('#loading-indicator').addClass('hidden');
                    renderResults(response.data);

                    // Reload history on success
                    loadHistory();

                    // Smooth scroll to results
                    $('html, body').animate({
                        scrollTop: $("#results-area").offset().top - 100
                    }, 500);

                    // Restore button
                    btn.prop('disabled', false).html(originalBtnHtml);
                },
                error: function (err) {
                    $('#loading-indicator').addClass('hidden');
                    const msg = err.responseJSON?.message || err.responseText || "Query execution failed";
                    $('#query-error-text').text(msg);
                    $('#query-error').removeClass('hidden');

                    // Smooth scroll to error
                    $('html, body').animate({
                        scrollTop: $("#query-error").offset().top - 100
                    }, 500);

                    // Restore button
                    btn.prop('disabled', false).html(originalBtnHtml);
                }
            });
        });
    });

    function loadHistory() {
        $.ajax({
            url: `/api/v1/connections/${connId}/history`,
            method: 'GET',
            success: function (response) {
                renderHistory(response.data);
            },
            error: function (err) {
                console.error("Failed to load history", err);
                $('#history-list').html('<div class="text-center py-8 text-gray-500 text-sm">Failed to load history</div>');
            }
        });
    }

    function renderHistory(data) {
        const list = $('#history-list');
        list.empty();

        if (!data || data.length === 0) {
            list.html('<div class="text-center py-8 text-gray-500 text-sm">No history yet</div>');
            return;
        }

        data.forEach(item => {
            const dateObj = new Date(item.created_at);
            const dateStr = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            const timeStr = dateObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Escape query for safe HTML attribute usage
            const safeQuery = escapeHtml(item.query);

            const html = `
                <div class="group relative bg-white/5 hover:bg-white/10 p-3 rounded-lg transition-all border border-transparent hover:border-primary-500/30 animate-fade-in-down">
                    <div class="flex justify-between items-start mb-2">
                         <div class="text-xs text-gray-400 font-mono">
                            <span class="text-gray-500 mr-1">${dateStr}</span>
                            ${timeStr}
                        </div>
                        <button onclick="setQuery(this)" data-query="${safeQuery}" 
                            class="p-1 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-colors" title="Apply this query">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                            </svg>
                        </button>
                    </div>
                   <div class="text-sm text-gray-200 font-mono line-clamp-3 break-all cursor-pointer hover:text-white" onclick="setQuery(this.parentElement.querySelector('button'))" title="${safeQuery}">${safeQuery}</div>
                </div>
            `;
            list.append(html);
        });
    }

    function renderResults(data) {
        if (!data) return;

        // Render Stats
        const stats = data.stats || {};
        $('#stat-duration').text((stats.execution_time_ms || 0) + ' ms');
        $('#stat-rows').text(formatNumber(stats.rows_read || 0));
        $('#stat-bytes').text(formatBytes(stats.bytes_read || 0));
        $('#stat-memory').text(formatBytes(stats.memory_peak || 0));
        $('#stat-parts').text(formatNumber(stats.parts_read || 0));
        $('#stat-marks').text(formatNumber(stats.marks_read || 0));

        // Render Table
        const cols = data.columns || [];
        const rows = data.rows || [];

        // Headers
        const headerHtml = cols.map(c => `<th scope="col" class="px-6 py-4 font-mono text-xs whitespace-nowrap text-primary-300 bg-gray-900/50">${c}</th>`).join('');
        $('#table-header').html(headerHtml);

        // Body
        if (rows.length === 0) {
            $('#table-body').empty();
            $('#no-results').removeClass('hidden');
            $('#limit-warning').addClass('hidden');
        } else {
            $('#no-results').addClass('hidden');

            // Limit rendered rows for DOM performance if needed (though backend might limit too)
            const displayRows = rows.slice(0, 100);
            if (rows.length > 100) $('#limit-warning').removeClass('hidden');
            else $('#limit-warning').addClass('hidden');

            const rowsHtml = displayRows.map((r, idx) => {
                const cells = cols.map(c => {
                    const val = r[c];
                    let display = val === null ? '<span class="text-gray-600 italic">NULL</span>' : escapeHtml(String(val));
                    if (val === '') display = '<span class="text-gray-700 italic">empty</span>';
                    return `<td class="px-6 py-3 whitespace-nowrap text-gray-300 font-mono text-xs border-r border-white/5 last:border-0">${display}</td>`;
                }).join('');
                return `<tr class="hover:bg-white/5 transition duration-150 ${idx % 2 === 0 ? 'bg-transparent' : 'bg-white/[0.02]'}">${cells}</tr>`;
            }).join('');
            $('#table-body').html(rowsHtml);
        }

        $('#results-area').removeClass('hidden');
    }

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Helper for history click
    function setQuery(btn) {
        const query = btn.getAttribute('data-query');
        editor.setValue(query);
        // Optional: Auto run?
        // $('#run-query-btn').click();
    }
</script>
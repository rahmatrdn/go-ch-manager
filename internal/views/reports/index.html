<div class="px-6 py-6" id="reports-container" data-connection-id="{{.ConnectionID}}">
    <div class="mb-6 flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Reports</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-slate-400">Analysis and insights from your ClickHouse server
            </p>
        </div>
    </div>

    <!-- Top 10 Slow Queries -->
    <div
        class="bg-white dark:bg-slate-800 shadow-sm rounded-xl overflow-hidden border border-gray-200 dark:border-slate-700">
        <div
            class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Top 10 Slow Queries</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-slate-400">Based on execution time in the last 24 hours
                </p>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-500 dark:text-slate-400" id="last-updated-text">
                    {{if .LastRefresh}}
                    Last updated: {{.LastRefresh.Format "02 Jan 2006 15:04:05"}}
                    {{else}}
                    Data not available
                    {{end}}
                </div>
                <button id="refresh-btn"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="refresh-icon" class="mr-2 -ml-1 h-4 w-4 transition-transform"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span id="refresh-label">Refresh Data</span>
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                <thead class="bg-gray-50 dark:bg-slate-800/50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">
                            Executed By</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider w-1/3">
                            Query (Normalized)</th>
                        <th scope="col"
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">
                            Executions</th>
                        <th scope="col"
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">
                            Avg Time (ms)</th>
                        <th scope="col"
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">
                            Max Time (ms)</th>
                        <th scope="col"
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">
                            Rows Read</th>
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only">View</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="reports-table-body"
                    class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-slate-700">
                    <!-- Data will be populated by JS to avoid duplication -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="query-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white dark:bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full border border-gray-200 dark:border-slate-700">
            <div class="bg-white dark:bg-slate-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                            Query Details (Sample)
                        </h3>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <div class="bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg">
                                <span
                                    class="block text-xs text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Executed
                                    By</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white mt-1"
                                    id="modal-executed-by">-</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg">
                                <span
                                    class="block text-xs text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Executions</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white mt-1"
                                    id="modal-executions">-</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg">
                                <span
                                    class="block text-xs text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Avg
                                    Duration</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white mt-1"
                                    id="modal-avg-duration">-</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg">
                                <span
                                    class="block text-xs text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Max
                                    Duration</span>
                                <span class="block text-sm font-medium text-amber-500 mt-1"
                                    id="modal-max-duration">-</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg">
                                <span
                                    class="block text-xs text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Rows
                                    Read</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white mt-1"
                                    id="modal-rows-read">-</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-700/50 p-3 rounded-lg">
                                <span
                                    class="block text-xs text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Bytes
                                    Read</span>
                                <span class="block text-sm font-medium text-gray-900 dark:text-white mt-1"
                                    id="modal-bytes-read">-</span>
                            </div>
                        </div>

                        <div class="mt-6 relative group">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="copyModalQuery()"
                                    class="bg-gray-800 text-white text-xs px-2 py-1 rounded hover:bg-gray-700 transition-colors">
                                    Copy
                                </button>
                            </div>
                            <pre
                                class="rounded-lg overflow-x-auto"><code class="language-sql text-sm rounded-lg" id="modal-query-content"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div
                class="bg-gray-50 dark:bg-slate-700/30 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200 dark:border-slate-700">
                <button type="button"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors"
                    onclick="copyModalQuery()">
                    Copy Query
                </button>
                <button type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-slate-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition-colors"
                    onclick="closeModal()">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global data store to avoid HTML attribute abuse
    let reportsData = [];
    let currentQuery = "";

    // Load initial data from Go template
    try {
        reportsData = JSON.parse('{{.Reports}}');
    } catch (e) {
        console.error("Init data error", e);
    }

    function renderTable() {
        const tableBody = $('#reports-table-body');
        tableBody.empty();

        if (!reportsData || reportsData.length === 0) {
            tableBody.append(`
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-sm text-gray-500 dark:text-slate-400 min-h-[200px] flex flex-col justify-center items-center h-full w-full">
                        No slow queries found in the last 24 hours.
                    </td>
                </tr>
            `);
            return;
        }

        reportsData.forEach((item, index) => {
            const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ${item.executed_by}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-slate-400 font-mono">
                        <div class="max-w-xl truncate cursor-pointer hover:text-amber-500 view-query-btn" 
                             title="Click to view full query" 
                             data-index="${index}">
                            ${item.query_normalized}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400 text-right">
                        ${item.executions}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400 text-right">
                        ${formatNumber(item.avg_duration_ms)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-600 dark:text-amber-500 font-medium text-right">
                        ${formatNumber(item.max_duration_ms)}
                    </td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400 text-right">
                        ${formatNumber(item.total_rows_read)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                         <button class="text-amber-600 hover:text-amber-900 dark:hover:text-amber-400 transition-colors view-query-btn"
                             data-index="${index}">
                            View
                        </button>
                    </td>
                </tr>
            `;
            tableBody.append(row);
        });
    }

    function openModal(index) {
        const item = reportsData[index];
        if (!item) return;

        currentQuery = item.sample_query || item.query_normalized;
        $('#modal-executed-by').text(item.executed_by);
        $('#modal-executions').text(formatNumber(item.executions));
        $('#modal-avg-duration').text(formatNumber(item.avg_duration_ms) + ' ms');
        $('#modal-max-duration').text(formatNumber(item.max_duration_ms) + ' ms');
        $('#modal-rows-read').text(formatNumber(item.total_rows_read));
        $('#modal-bytes-read').text(formatBytes(item.total_bytes_read));

        const codeElement = document.getElementById('modal-query-content');
        codeElement.textContent = currentQuery;
        hljs.highlightElement(codeElement);

        $('#query-modal').removeClass('hidden');
    }

    function closeModal() {
        $('#query-modal').addClass('hidden');
    }

    function copyModalQuery() {
        if (!currentQuery) return;
        navigator.clipboard.writeText(currentQuery).then(function () {
            // Optional: Show copied feedback
        }, function (err) {
            console.error('Could not copy text: ', err);
        });
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });

    function formatNumber(num) {
        if (num === undefined || num === null) return '-';
        return Math.round(Number(num)).toLocaleString('id-ID');
    }

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    $(document).ready(function () {
        const connectionID = $('#reports-container').data('connection-id');

        // Initial render
        renderTable();

        // Event delegation for view buttons
        $(document).on('click', '.view-query-btn', function () {
            const index = $(this).data('index');
            openModal(index);
        });

        $('#refresh-btn').click(function () {
            const btn = $(this);
            const icon = $('#refresh-icon');
            const label = $('#refresh-label');
            const lastUpdatedText = $('#last-updated-text');

            // Loading state
            btn.prop('disabled', true);
            icon.addClass('animate-spin');
            label.text('Refreshing...');
            NProgress.start();

            $.ajax({
                url: `/connections/${connectionID}/reports/slow-queries`,
                method: 'GET',
                data: { refresh: 'true', format: 'json' },
                dataType: 'json',
                success: function (response) {
                    if (response.last_refresh) {
                        const date = new Date(response.last_refresh);
                        const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' + date.toLocaleTimeString('en-GB', { hour12: false });
                        lastUpdatedText.text(`Last updated: ${dateStr}`);
                    }

                    if (response.data) {
                        reportsData = response.data;
                        renderTable();
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error refreshing data:", error);
                    alert("Failed to refresh data. Please try again.");
                },
                complete: function () {
                    btn.prop('disabled', false);
                    icon.removeClass('animate-spin');
                    label.text('Refresh Data');
                    NProgress.done();
                }
            });
        });
    });
</script>